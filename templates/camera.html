{% extends "base.html" %}
{% block title %}Camera{% endblock %}
{% block content %}
<div class="max-w-4xl mx-auto p-6">
    <h1 class="text-3xl font-bold mb-6">Camera</h1>

    <!-- Video stream và các nút chức năng -->
    <div class="mb-6">
        <video id="video" width="640" height="480" autoplay playsinline style="border: 2px solid #ccc;"></video>
        <canvas id="canvas" width="640" height="480" style="display: none;"></canvas>
        <div class="mt-4 flex space-x-4">
            <button id="captureImage" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Chụp ảnh</button>
            <button id="startVideo" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Quay video</button>
            <button id="stopVideo" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700" disabled>Stop video</button>
            <button id="liveDetect" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700">Nhận diện trực tiếp</button>
        </div>
    </div>

    <!-- Kết quả nhận diện trực tiếp -->
    <div id="liveResults" class="mt-6 p-4 bg-gray-100 rounded shadow">
        <h2 class="text-xl font-semibold mb-2">Kết quả nhận diện trực tiếp</h2>
        <ul id="detectionList" class="space-y-2"></ul>
    </div>

    <!-- Hiển thị ảnh/video đã xử lý (nếu có) -->
    <div id="processedMedia" class="mt-6" style="display: none;">
        {% if processed_filename %}
            {% if file_type == 'image' %}
                <img src="{{ url_for('uploaded_file', file_type='image', filename=processed_filename) }}" alt="Processed Image" class="w-full max-w-[640px] h-auto">
            {% else %}
                <video controls class="w-full max-w-[640px] h-auto">
                    <source src="{{ url_for('uploaded_file', file_type='video', filename=processed_filename) }}" type="video/mp4">
                    Trình duyệt của bạn không hỗ trợ video.
                </video>
            {% endif %}
        {% endif %}
    </div>
</div>

<script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const context = canvas.getContext('2d');
    const captureImage = document.getElementById('captureImage');
    const startVideo = document.getElementById('startVideo');
    const stopVideo = document.getElementById('stopVideo');
    const liveDetect = document.getElementById('liveDetect');
    const detectionList = document.getElementById('detectionList');
    let stream;
    let mediaRecorder;
    let recordedChunks = [];
    let isRecording = false;
    let liveDetectionInterval = null;

    // Khởi tạo camera
    function startCamera() {
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(s => {
                stream = s;
                video.srcObject = stream;
            })
            .catch(err => {
                console.error('Error accessing camera:', err);
                alert('Không thể truy cập camera: ' + err.message);
            });
    }

    // Dừng camera
    function stopCamera() {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            stream = null;
            video.srcObject = null;
        }
    }

    // Khởi động camera khi tải trang
    startCamera();

    // Chụp ảnh
    captureImage.addEventListener('click', () => {
        if (!stream) {
            alert('Camera chưa sẵn sàng. Vui lòng thử lại.');
            startCamera();
            return;
        }
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        canvas.toBlob(blob => {
            const formData = new FormData();
            formData.append('file', blob, 'capture.jpg');
            fetch('/camera', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.href = `/result/${data.filename}`;
                } else {
                    alert(data.error);
                }
            })
            .catch(err => {
                console.error('Error:', err);
                alert('Lỗi khi xử lý ảnh: ' + err.message);
            });
        }, 'image/jpeg');
    });

    // Quay video
    startVideo.addEventListener('click', () => {
        if (!stream) {
            alert('Camera chưa sẵn sàng. Vui lòng thử lại.');
            startCamera();
            return;
        }
        recordedChunks = [];
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.ondataavailable = event => {
            if (event.data.size > 0) {
                recordedChunks.push(event.data);
            }
        };
        mediaRecorder.onstop = () => {
            const blob = new Blob(recordedChunks, { type: 'video/mp4' });
            const formData = new FormData();
            formData.append('file', blob, 'capture.mp4');
            fetch('/camera', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.href = `/result/${data.filename}`;
                } else {
                    alert(data.error);
                }
            })
            .catch(err => {
                console.error('Error:', err);
                alert('Lỗi khi xử lý video: ' + err.message);
            });
            recordedChunks = [];
            isRecording = false;
        };
        mediaRecorder.start();
        isRecording = true;
        startVideo.disabled = true;
        stopVideo.disabled = false;
    });

    stopVideo.addEventListener('click', () => {
        if (mediaRecorder && isRecording) {
            mediaRecorder.stop();
            startVideo.disabled = false;
            stopVideo.disabled = true;
        }
    });

    // Nhận diện trực tiếp
    liveDetect.addEventListener('click', () => {
        if (!stream) {
            alert('Camera chưa sẵn sàng. Vui lòng thử lại.');
            startCamera();
            return;
        }
        if (liveDetectionInterval) {
            // Dừng nhận diện
            clearInterval(liveDetectionInterval);
            liveDetectionInterval = null;
            detectionList.innerHTML = '<li>Nhận diện đã dừng.</li>';
            liveDetect.textContent = 'Nhận diện trực tiếp';
            return;
        }
        liveDetect.textContent = 'Dừng nhận diện';
        liveDetectionInterval = setInterval(() => {
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            canvas.toBlob(blob => {
                const reader = new FileReader();
                reader.onloadend = () => {
                    const base64String = reader.result;
                    fetch('/process_frame', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ image: base64String })
                    })
                    .then(response => response.json())
                    .then(data => {
                        detectionList.innerHTML = ''; // Xóa kết quả cũ
                        if (data.success) {
                            const detections = data.detections;
                            if (detections.length > 0) {
                                detections.forEach(detection => {
                                    const li = document.createElement('li');
                                    li.textContent = `${detection.label}: Độ tin cậy: ${detection.confidence.toFixed(4)}`;
                                    detectionList.appendChild(li);
                                });
                            } else {
                                const li = document.createElement('li');
                                li.textContent = 'Không có đối tượng nào được phát hiện.';
                                detectionList.appendChild(li);
                            }
                        } else {
                            const li = document.createElement('li');
                            li.textContent = 'Lỗi: ' + data.error;
                            detectionList.appendChild(li);
                        }
                    })
                    .catch(err => {
                        console.error('Error:', err);
                        const li = document.createElement('li');
                        li.textContent = 'Lỗi khi nhận diện: ' + err.message;
                        detectionList.appendChild(li);
                    });
                };
                reader.readAsDataURL(blob);
            }, 'image/jpeg', 0.7); // Giảm chất lượng để tăng tốc
        }, 2000); // Gửi khung hình mỗi 2 giây để giảm tải
    });
</script>
{% endblock %}